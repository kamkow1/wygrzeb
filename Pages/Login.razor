@using Newtonsoft.Json
@using System.Text
@using wygrzebforum.Models

@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject WygrzebSessionData wygrzebSessionData
@inject NavigationManager nav

@page "/login"

@if (!wygrzebSessionData.IsUserLoggedIn)
{
    <div class="reg-form">
    <EditForm Model="@userModel" OnSubmit="@ValidOnSubmit">
        <DataAnnotationsValidator />

        <div class="form-input-block">
            <div class="form-group">
                <label for="login">Login</label>

                <div class="msg-invalid">
                    <ValidationMessage For="@(() => userModel.Login)"  />
                </div>

                <InputText @bind-Value="userModel.Login" 
                    class="form-control form-input" 
                    placeholder="wpisz login" id="login" />
            </div>
            <div class="form-group">
                <label for="password">Hasło</label>
                
                <div class="msg-invalid">
                    <ValidationMessage For="@(() => userModel.Password)" />
                </div>

                <InputText type="password" @bind-Value="userModel.Password" 
                    class="form-control form-input" 
                    placeholder="wpisz hasło" id="password" />
            </div>
            <div class="form-group" style="display: inline-block; margin-top: 2em;">
                <button type="submit" 
                    class="btn btn-outline-dark" 
                    style="margin-right: 1em;">zaloguj</button>
            </div>
        </div>
        
        @if ((int)response.StatusCode != 200)
        {
            <p class="text-centet text-danger">Nie udało się zalogować!</p>
        }
    </EditForm>
</div>
}
else 
{
    <div class="text-center">
        <h3>już jesteś zalogowany!</h3>
        <p>
            Teraz w pasku nawigacji możesz <a @onclick="NavToAccount" style="color: dodgerblue; text-decoration: underline;">wyświetlić swoje konto</a>, <br />
            możesz <a @onclick="NavToBrowse" style="color: dodgerblue; text-decoration: underline;">przeglądać dostępne artykuły</a> lub <a @onclick="NavToCreate" style="color: dodgerblue; text-decoration: underline;">stworzyć własny</a>
        </p>
    </div>
}

@code {
    User userModel = new();
    HttpResponseMessage response = new();

    async void ValidOnSubmit(EditContext editContext)
    {
        object userToSubmit = new 
        {
            login = userModel.Login,
            password = userModel.Password
        };

        var json = JsonConvert.SerializeObject(userToSubmit);
        var data = new StringContent(json, Encoding.UTF8, "application/json");

        var url = "https://localhost:44392/user/login";
        using var client = new HttpClient();

        response = await client.PostAsync(url, data);

        RequestResult result = response.Content.ReadAsAsync<RequestResult>().Result;

        if (response.IsSuccessStatusCode)
        {
            wygrzebSessionData.IsUserLoggedIn = true;
            wygrzebSessionData.CurrentUserId = result.id;
            wygrzebSessionData.RemoteIpAdress = result.ip;
            await sessionStorage.SetItemAsync("SessionState", wygrzebSessionData);

            Console.WriteLine(wygrzebSessionData.Dump());

            nav.NavigateTo("/", false);
        }
    }

    class RequestResult
    {
        public int id { get; set; }
        public string ip { get; set; }
    }
}

@functions {
    void NavToAccount()
    {
        nav.NavigateTo("account", false);
    }

    void NavToBrowse()
    {
        nav.NavigateTo("browse", false);
    }

    void NavToCreate()
    {
        nav.NavigateTo("create", false);
    }
}